<!DOCTYPE html>
<!--[if lte IE 8 ]>
<html class="ie" xmlns="http://www.w3.org/1999/xhtml" xml:lang="en-US" lang="en-US">
<![endif]-->
<!--[if (gte IE 9)|!(IE)]><!-->
<!--
***************  *      *     *
      8          *    *       *
      8          *  *         *
      8          **           *
      8          *  *         *
      8          *    *       *
      8          *      *     *
      8          *        *   ***********    -----Theme By Kieran(http://go.kieran.top)
-->
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="zh-CN" lang="zh-CN">
<!--<![endif]-->

<head>
  <title>Docker compose 使用 | Wh0am11&#39;s Blog</title>
  <!-- Meta data -->
    <meta http-equiv="Content-Type" content="text/html" charset="UTF-8" >
    <meta http-equiv="X-UA-Compatible" content="IE=edge"/>
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <meta name="generator" content="Wh0am11's Blog">
    <meta name="author" content="wh0am11">
    <meta name="description" content="xxx" />
    <meta name="keywords" content="zzz xxx ccc" />

    <!-- Favicon, (keep icon in root folder) -->
    <link rel="Shortcut Icon" href="/img/favicon.ico" type="image/ico">

    <link rel="alternate" href="/atom.xml" title="Wh0am11&#39;s Blog" type="application/atom+xml">
    <link rel="stylesheet" href="/css/all.css" media="screen" type="text/css">
    
    <link rel="stylesheet" href="/highlightjs/vs.css" type="text/css">
    

    <!--[if IE 8]>
    <link rel="stylesheet" type="text/css" href="/css/ie8.css" />
    <![endif]-->

    <!-- jQuery | Load our jQuery, with an alternative source fallback to a local version if request is unavailable -->
    <script src="/js/jquery-1.11.1.min.js"></script>
    <script>window.jQuery || document.write('<script src="js/jquery-1.11.1.min.js"><\/script>')</script>

    <!-- Load these in the <head> for quicker IE8+ load times -->
    <!-- HTML5 shim and Respond.js IE8 support of HTML5 elements and media queries -->
    <!--[if lt IE 9]>
    <script src="/js/html5shiv.min.js"></script>
    <script src="/js/respond.min.js"></script>
    <![endif]-->

  
  
  <link rel="alternate" type="application/atom+xml" title="Atom 0.3" href="atom.xml">
  
  

  <style>.col-md-8.col-md-offset-2.opening-statement img{display:none;}</style>
</head>

<!--
<body class="post-template">
-->
<body id="index" class="lightnav animsition">

      <!-- ============================ Off-canvas navigation =========================== -->

    <div class="sb-slidebar sb-right sb-style-overlay sb-momentum-scrolling">
        <div class="sb-close" aria-label="Close Menu" aria-hidden="true">
            <img src="/img/close.png" alt="Close"/>
        </div>
        <!-- Lists in Slidebars -->
        <ul class="sb-menu">
            <li><a href="/" class="animsition-link" title="Home">Home</a></li>
            <li><a href="/archives" class="animsition-link" title="archive">archives</a></li>
            <!-- Dropdown Menu -->
			 
            <li>
                <a class="sb-toggle-submenu">Works<span class="sb-caret"></span></a>
                <ul class="sb-submenu">
                    
                        <li><a href="/" target="_BLANK" class="animsition-link">AAA</a></li>
                    
                        <li><a href="/atom.xml" target="_BLANK" class="animsition-link">BBB</a></li>
                    
                </ul>
            </li>
            
            
        	<li>
        		<a class="sb-toggle-submenu">Categories<span class="sb-caret"></span></a>
            	<ul class="sb-submenu">
				  	
				    <li><a href="/categories/docker-compose/" class="animsition-link">docker compose<small>(4)</small></a></li>
				    
				</ul>
        	</li>
			
            
            <li>
                <a class="sb-toggle-submenu">Links<span class="sb-caret"></span></a>
                <ul class="sb-submenu">
                    
                    <li><a href="http://www.quanjinchu.com/" class="animsition-link">quanjinchu</a></li>
                    
                    <li><a href="http://www.quanjinchu.com/" class="animsition-link">quanjinchu</a></li>
                    
                </ul>
            </li>
            
        </ul>
        <!-- Lists in Slidebars -->
        <ul class="sb-menu secondary">
            
            <li><a href="/about.html" class="animsition-link" title="about">About</a></li>
            <li><a href="/atom.xml" class="animsition-link" title="rss">RSS</a></li>
        </ul>
    </div>
    
    <!-- ============================ END Off-canvas navigation =========================== -->

    <!-- ============================ #sb-site Main Page Wrapper =========================== -->

    <div id="sb-site">
        <!-- #sb-site - All page content should be contained within this id, except the off-canvas navigation itself -->

        <!-- ============================ Header & Logo bar =========================== -->

        <div id="navigation" class="navbar navbar-fixed-top">
            <div class="navbar-inner">
                <div class="container">
                    <!-- Nav logo -->
                    <div class="logo">
                        <a href="/" title="Logo" class="animsition-link">
                         <img src="/img/logo.png" alt="Logo" width="35px;"/> 
                        </a>
                    </div>
                    <!-- // Nav logo -->
                    <!-- Info-bar -->
                    <nav>
                        <ul class="nav">
                            <li><a href="/" class="animsition-link">Wh0am11's Blog</a></li>
                            <li class="nolink"><span>Always </span>Creative.</li>
                            
                            <li><a href="https://github.com/quanjinchu" title="Github" target="_blank"><i class="icon-github"></i></a></li>
                            
                            
                            
                            
                            
                            <li><a href="http://weibo.com/" title="Sina-Weibo" target="_blank"><i class="icon-sina-weibo"></i></a></li>
                            
                            <li class="nolink"><span>Welcome!</span></li>
                        </ul>
                    </nav>
                    <!--// Info-bar -->
                </div>
                <!-- // .container -->
                <div class="learnmore sb-toggle-right">More</div>
                <button type="button" class="navbar-toggle menu-icon sb-toggle-right" title="More">
                <span class="sr-only">Toggle navigation</span>
                <span class="icon-bar before"></span>
                <span class="icon-bar main"></span>
                <span class="icon-bar after"></span>
                </button>
            </div>
            <!-- // .navbar-inner -->
        </div>

        <!-- ============================ Header & Logo bar =========================== -->


      
<section id="intro">
    <div class="container">
        <div class="row col-md-offset-2">
            <div class="col-md-8">
    			<span class="post-meta">
      <time datetime="2019-09-11T19:00:00.000Z" itemprop="datePublished">
          2019-09-11
      </time>
    
</span>
                <h1>Docker compose 使用</h1>
            </div>
        </div>
        <div class="col-md-8 col-md-offset-2">
      		<p>通过Docker Compose构建一个简单的python应用程序，应用程序使用Flask framework以及redis来作点击计数器。虽然该示例使用Python，即使您不熟悉它，此处演示的概念也应该是可以理解的。</p>
<h2 id="前提条件"><a href="#前提条件" class="headerlink" title="前提条件"></a>前提条件</h2><p>确保已安装Docker Engine和Docker Compose，不需要安装python和redis，因为两者都由docker镜像提供</p>
<h2 id="步骤1-Setup"><a href="#步骤1-Setup" class="headerlink" title="步骤1: Setup"></a>步骤1: Setup</h2><p>定义应用依赖项</p>
<ol>
<li><p>创建项目目录</p>
<pre><code class="bash">mkdir composetest
cd composetest</code></pre>
</li>
<li><p>在项目目录中创建名为<code>app.py</code>的文件，并复制以下内容：</p>
<pre><code class="python">import time
import redis
from flask import Flask
app = Flask(__name__)
cache = redis.Redis(host=&#39;redis&#39;, port=6379)
def get_hit_count():
 retries = 5
 while True:
     try:
         return cache.incr(&#39;hits&#39;)
     except redis.exceptions.ConnectionError as exc:
         if retries == 0:
             raise exc
         retries -= 1
         time.sleep(0.5)
@app.route(&#39;/&#39;)
def hello():
 count = get_hit_count()
 return &#39;Hello World! I have been seen {} times.\n&#39;.format(count)</code></pre>
</li>
</ol>
<p>在此示例中，<code>redis</code>是redis容器在应用网络中的主机名，我们使用默认的6379作为redis服务的端口</p>
<ol start="3">
<li>另外在项目目录中创建名为<code>requirements.txt</code>的文件，并复制以下内容：</li>
</ol>
<pre><code class="text">flask
redis</code></pre>
<h2 id="步骤2-创建Dockerfile"><a href="#步骤2-创建Dockerfile" class="headerlink" title="步骤2: 创建Dockerfile"></a>步骤2: 创建Dockerfile</h2><p>在此步骤，编辑一个用来构建Docker image的Dockerfile。此镜像包含python应用所需的所有依赖项以及python本身</p>
<p>在你的项目目录中，创建名为<code>Dockerfile</code>的文件，并复制以下内容：</p>
<pre><code class="yaml">FROM python:3.7-alpine
WORKDIR /code
ENV FLASK_APP app.py
ENV FLASK_RUN_HOST 0.0.0.0
RUN apk add --no-cache gcc musl-dev linux-headers
COPY requirements.txt requirements.txt
RUN pip install -r requirements.txt
COPY . .
CMD [&quot;flask&quot;, &quot;run&quot;]</code></pre>
<p>以此来告诉docker：</p>
<ul>
<li>构建以python3.7-alpine为基础镜像的镜像</li>
<li>设置工作目录为<code>/code</code></li>
<li>设置<code>flask</code>命令使用的环境变量</li>
<li>安装gcc以便MarkupSafe and SQLAlchemy这样的Python包可加速编译</li>
<li>拷贝 <code>requirements.txt</code>文件到容器，并安装Python依赖项</li>
<li>拷贝当前目录所有文件到镜像中的工作目录</li>
<li>设置容器的默认命令为<code>flask run</code></li>
</ul>
<p>获取编写Dockerfile的更多详情，请查阅<a href="https://docs.docker.com/engine/tutorials/dockerimages/#building-an-image-from-a-dockerfile" target="_blank" rel="noopener">Docker user guide</a>以及<a href="https://docs.docker.com/engine/reference/builder/" target="_blank" rel="noopener"> Dockerfile reference</a></p>
<h2 id="步骤3-在Compose-file中定义services"><a href="#步骤3-在Compose-file中定义services" class="headerlink" title="步骤3: 在Compose file中定义services"></a>步骤3: 在Compose file中定义services</h2><p>在项目目录中创建名为<code>docker-compose.yml</code>的文件，并复制以下内容：</p>
<pre><code class="yaml">version: &#39;3&#39;
services:
  web:
    build: .
    ports:
      - &quot;5000:5000&quot;
  redis:
    image: &quot;redis:alpine&quot;</code></pre>
<p>此Compose file定义了两个services：<code>web</code>和<code>redis</code></p>
<h3 id="Web-service"><a href="#Web-service" class="headerlink" title="Web service"></a>Web service</h3><p>此 <code>web</code> service使用从当前目录的Dockerfile构建而来的镜像，然后构建容器并暴露主机端口<code>5000</code>，此示例service使用默认的<code>5000</code>端口作为Flask Web Server的端口</p>
<h3 id="Redis-service"><a href="#Redis-service" class="headerlink" title="Redis service"></a>Redis service</h3><p>此 <code>redis</code> service使用从Docker Hub仓库拉取而来的公共<a href="https://registry.hub.docker.com/_/redis/" target="_blank" rel="noopener">Redis</a>镜像</p>
<h2 id="步骤4-使用Compose构建和运行应用程序"><a href="#步骤4-使用Compose构建和运行应用程序" class="headerlink" title="步骤4: 使用Compose构建和运行应用程序"></a>步骤4: 使用Compose构建和运行应用程序</h2><ol>
<li><p>在项目目录中，执行<code>docker-compose up</code>来启动应用程序</p>
<pre><code class="bash">$ docker-compose up
Creating network &quot;composetest_default&quot; with the default driver
Creating composetest_web_1 ...
Creating composetest_redis_1 ...
Creating composetest_web_1
Creating composetest_redis_1 ... done
Attaching to composetest_web_1, composetest_redis_1
web_1    |  * Running on http://0.0.0.0:5000/ Press CTRL+C to quit
redis_1  | 1:C 17 Aug 22:11:10.480 # oO0OoO0OoO0Oo Redis is starting oO0OoO0OoO0Oo
redis_1  | 1:C 17 Aug 22:11:10.480 # Redis version=4.0.1, bits=64, commit=00000000, modified=0, pid=1, just started
redis_1  | 1:C 17 Aug 22:11:10.480 # Warning: no config file specified, using the default config. In order to specify a config file use redis-server /path/to/redis.conf
web_1    |  * Restarting with stat
redis_1  | 1:M 17 Aug 22:11:10.483 * Running mode=standalone, port=6379.
redis_1  | 1:M 17 Aug 22:11:10.483 # WARNING: The TCP backlog setting of 511 cannot be enforced because /proc/sys/net/core/somaxconn is set to the lower value of 128.
web_1    |  * Debugger is active!
redis_1  | 1:M 17 Aug 22:11:10.483 # Server initialized
redis_1  | 1:M 17 Aug 22:11:10.483 # WARNING you have Transparent Huge Pages (THP) support enabled in your kernel. This will create latency and memory usage issues with Redis. To fix this issue run the command &#39;echo never &gt; /sys/kernel/mm/transparent_hugepage/enabled&#39; as root, and add it to your /etc/rc.local in order to retain the setting after a reboot. Redis must be restarted after THP is disabled.
web_1    |  * Debugger PIN: 330-787-903
redis_1  | 1:M 17 Aug 22:11:10.483 * Ready to accept connections</code></pre>
<p>Compose拉取Redis镜像，为你的代码构建镜像，并且启动你定义的services。在此，代码在构建时被静态复制到镜像</p>
</li>
<li><p>在浏览器中访问<a href="http://localhost:5000/，查看正在运行的应用程序" target="_blank" rel="noopener">http://localhost:5000/，查看正在运行的应用程序</a></p>
</li>
</ol>
<p>如果您在Linux，Docker Desktop for Mac或Docker Desktop for Windows上本机使用Docker，那么Web应用程序现在应该在Docker守护程序主机上的端口5000上进行侦听。 将Web浏览器指向<a href="http://localhost:5000以查找`Hello" target="_blank" rel="noopener">http://localhost:5000以查找`Hello</a> World`消息。 如果不行，也可以尝试<a href="http://127.0.0.1:5000" target="_blank" rel="noopener">http://127.0.0.1:5000</a></p>
<p>如果您在Mac或Windows上使用Docker Machine，请使用<code>docker-machine ip MACHINE_VM</code>获取Docker主机的IP地址。 然后在浏览器中打开<code>http://MACHINE_VM_IP:5000</code></p>
<p>您可以在浏览器中看到一条消息：</p>
<pre><code class="html">Hello World! I have been seen 1 times.</code></pre>
<p><img src="../../themes/TKL/source/img/quick-hello-world-1.png" alt="avatar"></p>
<ol start="3">
<li>刷新页面</li>
</ol>
<p>数字会增长</p>
<pre><code class="html">Hello World! I have been seen 2 times.</code></pre>
<p><img src="../../themes/TKL/source/img/quick-hello-world-2.png" alt="avatar"></p>
<ol start="4">
<li>切换到另一个终端窗口</li>
</ol>
<pre><code class="bash">docker image ls
REPOSITORY              TAG                 IMAGE ID            CREATED             SIZE
composetest_web         latest              e2c21aa48cc1        4 minutes ago       93.8MB
python                  3.4-alpine          84e6077c7ab6        7 days ago          82.5MB
redis                   alpine              9d8fa9aa0e5b        3 weeks ago         27.5MB</code></pre>
<p>你可以用<code>docker inspect &lt;tag or id&gt;</code>查看镜像详情</p>
<ol start="5">
<li>在第二个终端的项目目录中执行<code>docker-compose down</code>，或者在启动应用程序的终端中按<code>CTRL+C</code>来停止应用</li>
</ol>
<h2 id="步骤5：编辑Compose-file添加挂载"><a href="#步骤5：编辑Compose-file添加挂载" class="headerlink" title="步骤5：编辑Compose file添加挂载"></a>步骤5：编辑Compose file添加挂载</h2><p>在项目目录中编辑<code>docker-compose.yml</code>文件，为 <code>web</code> service添加一个本地挂载:</p>
<pre><code class="yaml">version: &#39;3&#39;
services:
  web:
    build: .
    ports:
      - &quot;5000:5000&quot;
    volumes:
      - .:/code
    environment:
      FLASK_ENV: development
  redis:
    image: &quot;redis:alpine&quot;</code></pre>
<p>新的<code>volumes</code>键挂载宿主机中的项目目录(当前目录)到容器的<code>/code</code>目录，允许你动态修改代码，而无需重建映像。<code>environment</code>键设置<code>FLASK_ENV</code>的环境变量，它告诉flask运行在开发模式下运行并在更改时重新加载代码，这种模式仅应用于开发</p>
<h2 id="步骤6-使用compose重构并运行应用"><a href="#步骤6-使用compose重构并运行应用" class="headerlink" title="步骤6: 使用compose重构并运行应用"></a>步骤6: 使用compose重构并运行应用</h2><p>在你的项目目录， 使用已更新的Compose file，执行<code>docker-compose up</code>构建应用并运行</p>
<pre><code class="bash">$ docker-compose up
Creating network &quot;composetest_default&quot; with the default driver
Creating composetest_web_1 ...
Creating composetest_redis_1 ...
Creating composetest_web_1
Creating composetest_redis_1 ... done
Attaching to composetest_web_1, composetest_redis_1
web_1    |  * Running on http://0.0.0.0:5000/ (Press CTRL+C to quit)
...</code></pre>
<p>再次在浏览器中查看<code>Hello World</code>，并刷新页面查看计数增量</p>
<h2 id="Step-7-应用更新"><a href="#Step-7-应用更新" class="headerlink" title="Step 7: 应用更新"></a>Step 7: 应用更新</h2><p>因为应用程序代码通过卷数据挂载在容器中，你可以更改代码并即时查看更改，而无需重构镜像</p>
<ol>
<li>修改<code>app.py</code>中的问候语并保存，例如，修改<code>Hello World!</code>为<code>Hello from Docker</code>:<pre><code class="bash">return &#39;Hello from Docker! I have been seen {} times.\n&#39;.format(count)</code></pre>
</li>
<li>刷新浏览器，问候语已被更改，计数仍然在增长</li>
</ol>
<p><img src="../../themes/TKL/source/img/quick-hello-world-3.png" alt="avatar"></p>
<h2 id="Step-8-其他命令"><a href="#Step-8-其他命令" class="headerlink" title="Step 8: 其他命令"></a>Step 8: 其他命令</h2><p>如果你想在后台运行你的services，你可以将<code>-d</code>参数传递给<code>docker-compose up</code>，并使用<code>docker-compose ps</code> 查看当前正在运行的内容</p>
<pre><code class="bash">$ docker-compose up -d
Starting composetest_redis_1...
Starting composetest_web_1...

$ docker-compose ps
Name                 Command            State       Ports
-------------------------------------------------------------------
composetest_redis_1   /usr/local/bin/run         Up
composetest_web_1     /bin/sh -c python app.py   Up      5000-&gt;5000/tcp</code></pre>
<p><code>docker-compose run</code>命令允许你为services执行一次性命令，例如，查看<code>web</code> service可用的环境变量：</p>
<pre><code class="bash">$ docker-compose run web env</code></pre>
<p>如果你通过<code>docker-compose up -d</code>启动了服务，完成之后请停止此服务</p>
<pre><code class="bash">$ docker-compose stop</code></pre>
<p>你可以通过<code>down</code>命令停止所有服务，并完全性删除容器，也可以通过<code>--volumes</code>删除Redis容器使用的数据卷</p>
<pre><code class="bash">$ docker-compose down --volumes</code></pre>

            <div class="clearfix"></div>
            <hr class="nogutter">
        </div>
        <nav class="m-pagination col-md-8 col-md-offset-2 col-sm-24" role="pagination">
    
    
    <a class="pull-right" href="/2019/09/10/install/">
        Docker compose 安装 →
    </a>
    
</nav>

        <div class="col-md-8 col-md-offset-2 col-sm-24"><script type="text/javascript">
  /**
   * 搜狐畅言
   */

  /*
  document.write('<div id="SOHUCS" sid="' + window.location.pathname.slice(1) + '" ></div>');

  window.onload = function () {
    (function () {
      var appid = 'cytXXXX';
      var conf = 'prod_xxxxxxxxxxxxxxxxx';
      var width = window.innerWidth || document.documentElement.clientWidth;
      var loadJs = function (d, a, id) {
        var c = document.getElementsByTagName("head")[0] || document.head || document.documentElement;
        var b = document.createElement("script");
        b.setAttribute("type", "text/javascript");
        b.setAttribute("charset", "UTF-8");
        b.setAttribute("src", d);
        if (id) {
          b.setAttribute("id", id);
        }
        if (typeof a === "function") {
          if (window.attachEvent) {
            b.onreadystatechange = function () {
              var e = b.readyState;
              if (e === "loaded" || e === "complete") {
                b.onreadystatechange = null;
                a()
              }
            }
          } else {
            b.onload = a
          }
        }
        c.appendChild(b)
      };

      loadJs("https://changyan.sohu.com/upload/changyan.js", function () {
        window.changyan.api.config({
          appid: appid,
          conf: conf
        })
      });
    })();
  }
  */

</script>
</div>
    </div>
</section>


      
<!-- ============================ Footer =========================== -->

<footer>
    <div class="container">
            <div class="copy">
                <p>
                    &copy; 2014<script>new Date().getFullYear()>2010&&document.write("-"+new Date().getFullYear());</script>, Content By wh0am11. All Rights Reserved.
                </p>
                <p>Theme By <a href="//www.quanjinchu.com" style="color: #767D84">wh0am11</a></p>
            </div>
            <div class="social">
                <ul>
                    
                    <li><a href="https://github.com/quanjinchu" title="Github" target="_blank"><i class="icon-github"></i></a>&nbsp;</li>
                    
                    
                    
                    
                    
                    <li><a href="http://weibo.com/" title="Sina-Weibo" target="_blank"><i class="icon-sina-weibo"></i></a>&nbsp;</li>
                    
                </ul>
            </div>
            <div class="clearfix"> </div>
        </div>
</footer>

<!-- ============================ END Footer =========================== -->
      <!-- Load our scripts -->
<!-- Resizable 'on-demand' full-height hero -->
<script type="text/javascript">
    var resizeHero = function () {
        var hero = $(".cover,.heightblock"),
            window1 = $(window);
        hero.css({
            "height": window1.height()
        });
    };

    resizeHero();

    $(window).resize(function () {
        resizeHero();
    });
</script>
<script src="/js/plugins.min.js"></script><!-- Bootstrap core and concatenated plugins always load here -->
<script src="/js/scripts.js"></script><!-- Theme scripts -->


<link rel="stylesheet" href="/fancybox/jquery.fancybox.css" media="screen" type="text/css">
<script src="/fancybox/jquery.fancybox.pack.js"></script>
<script type="text/javascript">
$('#intro').find('img').each(function(){
  var alt = this.alt;

  if (alt){
    $(this).after('<span class="caption" style="display:none">' + alt + '</span>');
  }

  $(this).wrap('<a href="' + this.src + '" title="' + alt + '" class="fancybox" rel="gallery" />');
});
(function($){
  $('.fancybox').fancybox();
})(jQuery);
</script>



      
</body>
</html>
